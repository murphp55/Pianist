<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PianistApp.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Grid Padding="16" RowDefinitions="Auto,*" RowSpacing="12">
        <Frame Grid.Row="0" Padding="12">
            <Grid ColumnDefinitions="Auto,150,Auto,200,Auto,Auto,*" ColumnSpacing="8">
                <Label Text="Connection" VerticalTextAlignment="Center" TextColor="{StaticResource SubtleText}" />
                <Picker Grid.Column="1"
                        ItemsSource="{Binding ConnectionTypes}"
                        SelectedItem="{Binding SelectedConnectionType}" />
                <Label Grid.Column="2" Text="MIDI Device" VerticalTextAlignment="Center" TextColor="{StaticResource SubtleText}" />
                <Picker Grid.Column="3"
                        ItemsSource="{Binding MidiDevices}"
                        ItemDisplayBinding="{Binding Name}"
                        SelectedItem="{Binding SelectedDevice}" />
                <Button Grid.Column="4" Text="Refresh" Command="{Binding RefreshDevicesCommand}" />
                <Button Grid.Column="5" Text="{Binding ConnectButtonText}" Command="{Binding ToggleConnectCommand}" />
                <Label Grid.Column="6"
                       Text="{Binding ConnectionStatus}"
                       VerticalTextAlignment="Center"
                       TextColor="{StaticResource MutedText}" />
            </Grid>
        </Frame>

        <Grid Grid.Row="1" ColumnDefinitions="Auto,*,2*" ColumnSpacing="12">
            <VerticalStackLayout Spacing="8">
                <Button Text="Menu" Command="{Binding ToggleTocCommand}" WidthRequest="72" />
            </VerticalStackLayout>

            <Frame Grid.Column="1" Padding="12" IsVisible="{Binding IsTocOpen}">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Practice Table of Contents" FontSize="15" FontAttributes="Bold" />
                    <CollectionView ItemsSource="{Binding TocGroups}"
                                    IsGrouped="True"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedTocItem}">
                        <CollectionView.GroupHeaderTemplate>
                            <DataTemplate>
                                <Label Text="{Binding Title}" FontAttributes="Bold" Margin="0,8,0,4" />
                            </DataTemplate>
                        </CollectionView.GroupHeaderTemplate>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Label Text="{Binding Title}" Margin="12,2" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <Frame Grid.Column="2" Padding="14">
                <ScrollView>
                    <VerticalStackLayout Spacing="10">
                        <HorizontalStackLayout Spacing="8">
                            <Button Text="Start Task" Command="{Binding StartTaskCommand}" IsEnabled="{Binding CanStart}" />
                            <Button Text="Stop Task" Command="{Binding StopTaskCommand}" IsEnabled="{Binding CanStop}" />
                            <Button Text="Complete Lesson" Command="{Binding CompleteLessonCommand}" IsEnabled="{Binding CanCompleteLesson}" />
                            <Button Text="Reset" Command="{Binding ResetTaskCommand}" />
                        </HorizontalStackLayout>

                        <Label Text="{Binding TaskStatus}" FontAttributes="Bold" FontSize="15" TextColor="{StaticResource Accent}" />

                        <VerticalStackLayout Spacing="6">
                            <Label Text="Lesson Details" FontAttributes="Bold" />
                            <Label Text="{Binding SelectedTask.Description}" TextColor="{StaticResource SubtleText}" />
                            <Label>
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Requires MIDI: " />
                                        <Span Text="{Binding SelectedTask.RequiresMidiInput, Converter={StaticResource BoolToYesNoConverter}}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Label>
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Metronome Required: " />
                                        <Span Text="{Binding SelectedTask.RequireMetronome, Converter={StaticResource BoolToYesNoConverter}}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Label Text="{Binding SelectedProgressText}" />
                            <Label Text="{Binding SelectedLastCompletedText}" />
                        </VerticalStackLayout>

                        <Label Text="{Binding ProgressText}" />
                        <Label Text="{Binding AccuracyText}" />
                        <Label Text="{Binding MetronomeText}" />
                        <Label Text="{Binding LastNoteText}" />

                        <VerticalStackLayout Spacing="6">
                            <Label Text="Expected Notes" FontAttributes="Bold" />
                            <FlexLayout BindableLayout.ItemsSource="{Binding SelectedTask.ExpectedNoteNames}"
                                        Wrap="Wrap"
                                        JustifyContent="Start"
                                        AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <Frame Padding="6,2" Margin="0,0,6,6" BackgroundColor="#F2F2F2" CornerRadius="4">
                                            <Label Text="{Binding}" FontAttributes="Bold" />
                                        </Frame>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="6">
                            <Label Text="Fingering Diagram" FontAttributes="Bold" />
                            <Frame Padding="10" BackgroundColor="#FAFAFA" BorderColor="{StaticResource PanelBorder}">
                                <Grid>
                                    <GraphicsView Drawable="{Binding FingeringDrawable}" HeightRequest="150" />
                                    <Label Text="No fingering diagram for this lesson."
                                           TextColor="{StaticResource MutedText}"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center"
                                           IsVisible="{Binding ShowFingeringPlaceholder}" />
                                </Grid>
                            </Frame>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>
